## ğŸ“Š **éœ€è¦è¡¥å……çš„å›¾è¡¨ (æŒ‰ä¼˜å…ˆçº§æ’åº)**

### ğŸ”´ **é«˜ä¼˜å…ˆçº§ - å¿…é¡»è¡¥å……**

#### 1. **æ—¶é—´è½´å¯¹æ¯”å›¾** (ç±»ä¼¼ SpecInfer Fig 1b)
**ç¼ºå¤±åŸå› **ï¼šè®ºæ–‡éœ€è¦ç›´è§‚å±•ç¤º DynaTree çš„æ ¸å¿ƒä¼˜åŠ¿  
**å†…å®¹**ï¼š
- ä¸‰æ¡æ—¶é—´è½´å¯¹æ¯”ï¼š
  - **Autoregressive**: Targeté€ä¸ªç”Ÿæˆ tâ‚, tâ‚‚, tâ‚ƒ, tâ‚„ (ä¸²è¡Œ)
  - **Linear Speculative**: Draftç”Ÿæˆé“¾ â†’ Targetå¹¶è¡ŒéªŒè¯ â†’ æ¥å—éƒ¨åˆ†
  - **DynaTree**: Draftç”Ÿæˆæ ‘ â†’ Targetä¸€æ¬¡æ€§éªŒè¯æ•´æ£µæ ‘ â†’ æ¥å—æ›´å¤štokens
- **ä½œç”¨**ï¼šçªå‡ºæ ‘å½¢ç»“æ„åœ¨å•è½®ä¸­éªŒè¯æ›´å¤šå€™é€‰çš„ä¼˜åŠ¿

---

#### 2. **Tree Attention Mask å¯è§†åŒ–** (ç±»ä¼¼ SpecInfer Fig 4)
**ç¼ºå¤±åŸå› **ï¼šTree Attentionæ˜¯æ ¸å¿ƒåˆ›æ–°ï¼Œä½†ç›®å‰åªåœ¨æ¶æ„å›¾ä¸­ä¸€ç¬”å¸¦è¿‡  
**å†…å®¹**ï¼š
```
å·¦ä¾§ï¼šå±•ç¤ºä¸€ä¸ªå…·ä½“çš„æ ‘ç»“æ„ï¼ˆå¦‚æ·±åº¦3ï¼Œåˆ†æ”¯2ï¼‰
      tâ‚€
     / \
   tâ‚  tâ‚‚
   / \  |
 tâ‚ƒ tâ‚„ tâ‚…

å³ä¾§ï¼šå¯¹åº”çš„ Attention Mask çŸ©é˜µçƒ­åŠ›å›¾
      - æ¯ä¸ªtokenèƒ½attendå“ªäº›ä½ç½®ï¼ˆancestors + prefixï¼‰
      - ç”¨é¢œè‰²åŒºåˆ†ï¼šprefix (è“), ancestors (ç»¿), blocked (ç™½)
```
- **ä½œç”¨**ï¼šå±•ç¤ºå¦‚ä½•åœ¨ä¿æŒå› æœæ€§çš„å‰æä¸‹å®ç°å¹¶è¡ŒéªŒè¯

---

#### 3. **ä¸åŒç”Ÿæˆé•¿åº¦ä¸‹çš„æ€§èƒ½æ›²çº¿**
**ç¼ºå¤±åŸå› **ï¼šä½œä¸šè¦æ±‚æµ‹è¯•ä¸åŒé•¿åº¦ï¼Œå½“å‰åªæœ‰500 tokensçš„ä¸»å®éªŒ  
**å†…å®¹**ï¼š
- Xè½´ï¼šç”Ÿæˆé•¿åº¦ (100, 200, 300, 500, 1000 tokens)
- Yè½´ï¼šThroughput (tokens/sec)
- æ›²çº¿ï¼šAR, HF Assisted, Linear, DynaTree
- **æ•°æ®æ¥æº**ï¼šä½ ä»¬å·²æœ‰çš„ length scaling å®éªŒæ•°æ®
- **ä½œç”¨**ï¼šå±•ç¤º DynaTree åœ¨ä¸åŒé•¿åº¦ä¸‹çš„ç¨³å®šæ€§

---

#### 4. **Acceptance Rate å’Œ Tokens-per-Iteration å¯¹æ¯”è¡¨**
**ç¼ºå¤±åŸå› **ï¼šSpecInfer æœ‰è¯¦ç»†çš„ token éªŒè¯åˆ†æ (Table 1, 2)  
**å†…å®¹**ï¼š
```
| Method               | Avg Tokens/Iter | Acceptance Rate | Avg Path Length |
|---------------------|----------------|-----------------|-----------------|
| Linear (K=6)        | 2.3            | 38.3%           | 2.3             |
| HF Assisted         | 2.8            | -               | -               |
| DynaTree (D=8,B=3)  | 3.7            | 62.4%           | 4.1             |
```
- **æ•°æ®æ¥æº**ï¼šå‚æ•°æ‰«æç»“æœä¸­æœ‰ acceptance rate
- **ä½œç”¨**ï¼šé‡åŒ–è¯æ˜ DynaTree çš„éªŒè¯æ•ˆç‡

---

### ğŸŸ¡ **ä¸­ä¼˜å…ˆçº§ - å¼ºçƒˆæ¨è**

#### 5. **ä¸åŒæ ‘ç»“æ„é…ç½®çš„æ€§èƒ½å¯¹æ¯”** (ç±»ä¼¼ SpecInfer Fig 10)
**å†…å®¹**ï¼š
- å›ºå®šé•¿åº¦ (500 tokens)ï¼Œå¯¹æ¯”ä¸åŒ (D, B, Ï„) é…ç½®
- 3ä¸ªå­å›¾ï¼š
  - (a) Speedup vs Depth (D=3~8, å›ºå®šB=3, Ï„=0.03)
  - (b) Speedup vs Branch Factor (B=2~4, å›ºå®šD=8, Ï„=0.03)
  - (c) Speedup vs Threshold (Ï„=0.01~0.1, å›ºå®šD=8, B=3)
- **æ•°æ®æ¥æº**ï¼šå·²æœ‰çš„å‚æ•°æ‰«ææ•°æ®
- **ä½œç”¨**ï¼šå±•ç¤ºåŠ¨æ€å‰ªæçš„å¿…è¦æ€§ï¼ˆè¿‡å¤§çš„æ ‘ä¼šé™ä½æ€§èƒ½ï¼‰

---

#### 6. **æ¶ˆèå®éªŒçš„å¯è§†åŒ–** (Bar Chart)
**å†…å®¹**ï¼šå°† Table 2 çš„æ¶ˆèå®éªŒè½¬æˆæŸ±çŠ¶å›¾
```
Full DynaTree:        193.4 tok/s â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
w/o Pruning:         145.2 tok/s â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
w/o Node Budget:     132.1 tok/s â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
Fixed Tree (D=5,B=2): 156.8 tok/s â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
```
- **ä½œç”¨**ï¼šæ›´ç›´è§‚åœ°å±•ç¤ºæ¯ä¸ªç»„ä»¶çš„è´¡çŒ®

---

#### 7. **å†…å­˜ä½¿ç”¨å¯¹æ¯”**
**ç¼ºå¤±åŸå› **ï¼šä½œä¸šæ˜ç¡®è¦æ±‚"æ›´çœæ˜¾å­˜"  
**å†…å®¹**ï¼š
```
| Method          | Peak Memory (GB) | KV Cache Size (MB) |
|----------------|------------------|--------------------|
| AR             | 5.2              | 45                 |
| Linear (K=8)   | 5.4              | 48                 |
| DynaTree       | 5.6              | 52 (pruned tree)   |
```
- **éœ€è¦æ–°å®éªŒ**ï¼šç”¨ `torch.cuda.max_memory_allocated()` æµ‹é‡
- **ä½œç”¨**ï¼šè¯æ˜ DynaTree çš„å†…å­˜å¼€é”€å¯æ§

---

### ğŸŸ¢ **ä½ä¼˜å…ˆçº§ - å¯é€‰è¡¥å……**

#### 8. **TTFT å’Œ TPOT æŒ‡æ ‡** (Table)
**ç¼ºå¤±åŸå› **ï¼šä½œä¸šè¦æ±‚æŠ¥å‘Šè¿™äº›æŒ‡æ ‡  
**å†…å®¹**ï¼š
```
| Method     | TTFT (ms) | TPOT (ms) | Throughput |
|-----------|-----------|-----------|------------|
| AR        | 42.1      | 8.4       | 119.4      |
| DynaTree  | 98.3      | 5.2       | 193.4      |
```
- **è¯´æ˜**ï¼šTTFT ä¼šæ›´é«˜ï¼ˆå› ä¸ºè¦å…ˆæ„å»ºæ ‘ï¼‰ï¼Œä½† TPOT æ›´ä½

---

#### 9. **ä¸åŒ Batch Size çš„æ€§èƒ½** (å¦‚æœæœ‰æ¡ä»¶)
**å†…å®¹**ï¼šBatch Size = 1, 2, 4, 8 ä¸‹çš„æ€§èƒ½å¯¹æ¯”
- **è¯´æ˜**ï¼šSpecInfer å‘ç°å¤§ batch size ä¸‹æ”¶ç›Šå‡å°

---

## ğŸ§ª **éœ€è¦è¡¥å……çš„å®éªŒ**

### ğŸ”´ **å¿…é¡»è¡¥å……**

#### 1. **åœ¨ WikiText å’Œ PG-19 æ•°æ®é›†ä¸Šçš„æµ‹è¯•**
**ä½œä¸šè¦æ±‚åŸæ–‡**ï¼š
> åœ¨ pg-19, wikitext ç­‰æ•°æ®é›†ä¸Šè¿›è¡Œ ppl æµ‹è¯•å’ŒåŠ é€Ÿæµ‹è¯•

**éœ€è¦åšçš„**ï¼š
```python
# WikiText-103
dataset = load_dataset("wikitext", "wikitext-103-v1")
test_samples = dataset['test'][:10]  # å–10ä¸ªæ ·æœ¬

# PG-19 (è¶…é•¿æ–‡æœ¬)
dataset = load_dataset("pg19")
test_sample = dataset['test'][0]  # å–1ä¸ªé•¿æ ·æœ¬

# æµ‹è¯•æŒ‡æ ‡ï¼š
# 1. PPL (perplexity) - è¯æ˜ä¸æŸå®³è´¨é‡
# 2. Throughput - åŠ é€Ÿæ•ˆæœ
# 3. ä¸åŒ prompt é•¿åº¦çš„æ€§èƒ½
```

---

#### 2. **PPL æµ‹è¯• (è¯æ˜æ­£ç¡®æ€§)**
**ä½œä¸šè¦æ±‚**ï¼šæ˜ç¡®è¦æ±‚ ppl æµ‹è¯•  
**å®éªŒè®¾è®¡**ï¼š
```python
# ç›®çš„ï¼šè¯æ˜ DynaTree è¾“å‡ºä¸ AR å®Œå…¨ä¸€è‡´
# æ–¹æ³•ï¼š
# 1. ç”¨ AR ç”Ÿæˆ 1000 tokensï¼Œè®¡ç®— ppl
# 2. ç”¨ DynaTree ç”Ÿæˆç›¸åŒçš„ 1000 tokens (greedy ä¿è¯ä¸€è‡´)
# 3. éªŒè¯ä¸¤è€… ppl å®Œå…¨ç›¸åŒ

# é¢„æœŸç»“æœï¼š
# AR:       PPL = 12.34
# DynaTree: PPL = 12.34 (å®Œå…¨ç›¸åŒ)
```

---

#### 3. **å†…å­˜ä½¿ç”¨æµ‹é‡**
**ä»£ç **ï¼š
```python
import torch

torch.cuda.reset_peak_memory_stats()
# è¿è¡Œ DynaTree
peak_memory = torch.cuda.max_memory_allocated() / 1024**3  # GB
```

---

### ğŸŸ¡ **æ¨èè¡¥å……**

#### 4. **TTFT å’Œ TPOT æµ‹é‡**
```python
import time

# TTFT: Time To First Token
start = time.time()
first_token = generate_first_token()
ttft = time.time() - start

# TPOT: Time Per Output Token
start = time.time()
output = generate(n_tokens=100)
tpot = (time.time() - start) / 100
```

---

#### 5. **ä¸åŒ Prompt é•¿åº¦çš„æ€§èƒ½**
**å®éªŒ**ï¼šå›ºå®šç”Ÿæˆ 500 tokensï¼Œæ”¹å˜ prompt é•¿åº¦
- Prompt lengths: 50, 100, 200, 500, 1000 tokens
- æµ‹è¯• DynaTree æ˜¯å¦åœ¨é•¿ prompt ä¸‹ä»æœ‰ä¼˜åŠ¿

---

## ğŸ“‹ **ä¼˜å…ˆçº§æ€»ç»“**

### **æœ¬å‘¨å¿…é¡»å®Œæˆ (é«˜ä¼˜å…ˆçº§)**ï¼š
1. âœ… æ—¶é—´è½´å¯¹æ¯”å›¾ â†’ å¿«é€Ÿç”»å›¾å·¥å…· (PPT/Figma)
2. âœ… Tree Attention Mask å¯è§†åŒ– â†’ Python matplotlib
3. âœ… WikiText/PG-19 æ•°æ®é›†å®éªŒ â†’ è¿è¡Œå®éªŒè„šæœ¬
4. âœ… PPL æµ‹è¯• â†’ ç®€å•å®éªŒéªŒè¯æ­£ç¡®æ€§
5. âœ… Acceptance Rate è¡¨æ ¼ â†’ æ•´ç†ç°æœ‰æ•°æ®

### **æ¨èå®Œæˆ (ä¸­ä¼˜å…ˆçº§)**ï¼š
6. â­ æ ‘ç»“æ„é…ç½®å¯¹æ¯”å›¾ â†’ ç°æœ‰æ•°æ®å¯è§†åŒ–
7. â­ å†…å­˜ä½¿ç”¨æµ‹é‡ â†’ ç®€å•å®éªŒ
8. â­ æ¶ˆèå®éªŒå¯è§†åŒ– â†’ ç°æœ‰æ•°æ®è½¬å›¾è¡¨

### **å¯é€‰è¡¥å…… (ä½ä¼˜å…ˆçº§)**ï¼š
9. TTFT/TPOT è¡¨æ ¼
10. ä¸åŒ batch size æ€§èƒ½
